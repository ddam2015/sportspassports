$( document ).ready(function(){
  $('.container').append('<h1 class="loader small-12 medium-12 large-12">Loading<img class="width-30-30" src="https://dev.sportspassports.com/wp-content/uploads/spp-loading-logo.gif"></h1>');
  $('.spp-container').hide();
  var site_type = (document.location.host).includes('dev.');
  var site_url;
  if(site_type === true){
    site_url = 'https://dev.sportspassports.com/api-data-form/';
  }else{
    site_url = 'https://sportspassports.com/api-data-form/';
  }
  function init_slb_table(){
    $('.loader').remove();
    $('.spp-container').show();
    var slb_json_obj = $('#spp-post-data')[0].innerText;
    var slb_array = $.parseJSON(slb_json_obj);
    var selected_year = slb_array.year_list[0].value;
    slb_array.events.forEach(function(element){ $('.event-selector select').append('<option value="'+element.id+'">'+element.name+'</option>'); });
    slb_array.levels_of_play.forEach(function(element){ $('.lv_play select').append('<option value="'+element+'">'+element+'</option>'); });
    slb_array.dv_list.forEach(function(element){ $('.dv_list select').append('<option value="'+element.level+'">'+element.name+'</option>'); });
    slb_array.year_list.forEach(function(element){ $('.year_list select').append('<option value="'+element.value+'">'+element.name+'</option>'); });
    document.getElementById('spp_org_logo_img').src = slb_array.events[0].logo_img;
    document.getElementById('spp_org_logo_img').alt = slb_array.events[0].name;
    $('#spp_event_location').append('<h4>'+ slb_array.events[0].locations +'</h4>');
    $('#spp_event_date').append('<h4>'+ slb_array.events[0].dates +'</h4>');
    slb_array.stat_leaderboard_data.stat_point.forEach(function(element){
        $('.slb_player_table').append('<tr><td><div><a class="flex align-middle" href="https://sportspassports.com/player/'+element.player_nickname+'/stats/'+element.event_id+'/'+selected_year+'/tournament/#'+element.event_name+'" target="_blank"><div class="small-padding-right"><figure><div class="image-wrapper"><img alt="'+element.player_nickname+'" title="'+element.player_name+'" data-mptype="image" src="'+element.player_img+'" class="rounded"></div></figure></div>'+element.player_name+'</a></div></td><td class="text-left small-padding-right">'+element.player_division+'</td><td class="text-left small-padding-right">'+element.player_level+'</td><td class="text-left small-padding-right">'+(Math.round(element.stat_point * 100) / 100).toFixed(1)+'</td></tr>');
    });
    $('#spp_stat_year').on('change', function(){
      var select_year = $('#spp_stat_year').val();
      var filter_year = true;
      get_slb(filter_year);
    });
  }
  function post_data_request(target_location){
    $.ajax({
      url: target_location,
      type: 'GET',
      success: function(response_data){
        $('#spp-slb-container').append('<div id="spp-post-data" class="hide">'+response_data+'</div>');
        init_slb_table();
      },
      error: function(error){
        console.log('error: ' + error);
      }
    });
  }
  const callback = new MutationObserver((mutationList, observer) => {
    const spp_post_data = document.getElementById('admin_keys');
    if(spp_post_data){ 
      post_data_request(spp_post_data.innerText); observer.disconnect(); return; 
    }
  });
  callback.observe(document, {
   childList: true,
   subtree: true
  });
});
function get_slb(filter_year){
  $('.container').append('<h1 class="loader small-12 medium-12 large-12">Loading<img class="width-30-30" src="https://dev.sportspassports.com/wp-content/uploads/spp-loading-logo.gif"></h1>');
  var site_type = (document.location.host).includes('dev.');
  var site_url;
  if(site_type === true){
    site_url = 'https://dev.sportspassports.com/api-data-form/';
  }else{
    site_url = 'https://sportspassports.com/api-data-form/';
  }
  var request_url = document.location.hostname;
  var url = document.getElementById('spp_request_url').outerText;
  var event_list = document.getElementById('event_list');
  var stat_catagory = (document.getElementById('stat_catagory')).value;
  var roster_lv = (document.getElementById('roster_dvs')).value;
  var roster_dv = (document.getElementById('roster_level')).value;
  var event_id = event_list.value;
  var event_name = event_list.options[event_list.selectedIndex].text;
  if(filter_year === true){ event_id = ''; }
  var selected_year = (document.getElementById('spp_stat_year')).value;
  var filter_options = ['get_ev=' + event_id, 'get_st_cat=' + stat_catagory, 'roster_lv=' + roster_lv, 'roster_dv=' + roster_dv, 'request_url=' + request_url, 'select_year=' + selected_year].join('&');
  filter_options.toString();
  var post_data = $('#spp-post-data');
  $('.stat_leaderboard').remove();
  document.getElementById('spp_event_location').innerText = '';
  document.getElementById('spp_org_logo_img').style = 'display: none';
  document.getElementById('spp_event_date').innerText = '';
  post_data[0].innerText = '';
  var get_url = new URL(url);
  get_url.searchParams.append('filter_options', filter_options);
  $.ajax({
    type: 'POST',
    url: site_url,
    data: {post_event_id: event_id, stat_type: stat_catagory, level_type: roster_lv, select_year: selected_year},
    success: function(response){
      $('.spp-container').append(response);
      $.ajax({
        type: 'GET',
        url: get_url.href,
        contentType: "application/json",
        success: function(response){
          $('.loader').remove();
          $('#spp-post-data').append(response);
          var slb_json_obj = $('#spp-post-data')[0].innerText;
          var slb_array = $.parseJSON(slb_json_obj);
          var selected_ev = '';
          function additional_event_info(element){
            document.getElementById('spp_org_logo_img').src = element.logo_img;
            $('#spp_event_date').append('<h4>'+ slb_array.events[0].dates +'</h4>');
            $('#spp_event_location').append('<h4>'+ element.locations +'</h4>');
            document.getElementById('spp_org_logo_img').alt = element.name;
            document.getElementById('spp_org_logo_img').style = 'display: initial';
          }
          slb_array.events.forEach(function(element){ if(element.id === event_id){ additional_event_info(element); } });
          if(filter_year === true){
            if(selected_year){ $('.event-selector option').remove(); }
            slb_array.events.forEach(function(element){
              $('.event-selector select').append('<option value="'+element.id+'">'+element.name+'</option>');
              if(element.id === slb_array.events[0].id){ additional_event_info(element); }
            });
          }
          if(slb_array.stat_leaderboard_data[stat_catagory]){
            slb_array.stat_leaderboard_data[stat_catagory].forEach(function(element){
              $('.slb_player_table').append('<tr><td><div><a class="flex align-middle" href="https://sportspassports.com/player/'+element.player_nickname+'/stats/'+element.event_id+'/'+selected_year+'/tournament/#'+element.event_name+'" target="_blank"><div class="small-padding-right"><figure><div class="image-wrapper"><img alt="'+element.player_nickname+'" title="'+element.player_name+'" data-mptype="image" src="'+element.player_img+'" class="rounded"></div></figure></div>'+element.player_name+'</a></div></td><td class="text-left small-padding-right">'+element.player_division+'</td><td class="text-left small-padding-right">'+element.player_level+'</td><td class="text-left small-padding-right">'+(Math.round(element[stat_catagory] * 100) / 100).toFixed(1)+'</td></tr>');
            });
          }else{ $('.slb_player_table').append('<h3 class="text-center small-padding small-12 medium-12 large-12">There is no result for selected options.</h3>'); }
        }
      })
    }
  })
}